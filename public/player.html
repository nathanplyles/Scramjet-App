<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>* { margin:0; padding:0; } body { background:#000; }</style>
</head>
<body>
<div id="p"></div>
<script>
console.log('[player] page loaded');

var player, ready = false, pendingCmd = null;

window.onYouTubeIframeAPIReady = function() {
  console.log('[player] YT API ready, creating player...');
  player = new YT.Player('p', {
    height: '180', width: '320',
    videoId: 'jNQXAC9IVRw',
    playerVars: { autoplay: 0, controls: 0, rel: 0, playsinline: 1, mute: 1 },
    events: {
      onReady: function() {
        console.log('[player] onReady fired!');
        ready = true;
        player.stopVideo();
        player.unMute();
        try {
          window.parent.postMessage({ type: 'PLAYER_READY' }, '*');
          console.log('[player] postMessage sent to parent');
        } catch(e) {
          console.error('[player] postMessage failed:', e);
        }
        if (pendingCmd) { handleCmd(pendingCmd); pendingCmd = null; }
      },
      onStateChange: function(e) {
        console.log('[player] state change:', e.data);
        window.parent.postMessage({ type: 'STATE', state: e.data }, '*');
      },
      onError: function(e) {
        console.error('[player] error:', e.data);
        window.parent.postMessage({ type: 'ERROR', code: e.data }, '*');
      }
    }
  });
};

window.onerror = function(msg, src, line) {
  console.error('[player] uncaught error:', msg, src, line);
};

var tag = document.createElement('script');
tag.onload = function() { console.log('[player] YT script loaded'); };
tag.onerror = function() { console.error('[player] YT script FAILED to load'); };
tag.src = 'https://www.youtube.com/iframe_api';
document.head.appendChild(tag);
console.log('[player] YT script tag added');

function handleCmd(cmd) {
  console.log('[player] handleCmd:', cmd);
  if (!player) return;
  if (cmd.action === 'play') {
    player.loadVideoById(cmd.videoId);
    player.setVolume(cmd.volume != null ? cmd.volume : 80);
  } else if (cmd.action === 'pause') {
    player.pauseVideo();
  } else if (cmd.action === 'resume') {
    player.playVideo();
  } else if (cmd.action === 'seek') {
    player.seekTo(cmd.time, true);
  } else if (cmd.action === 'volume') {
    player.setVolume(cmd.volume);
  } else if (cmd.action === 'getTime') {
    window.parent.postMessage({
      type: 'TIME',
      current: player.getCurrentTime(),
      duration: player.getDuration()
    }, '*');
  }
}

window.addEventListener('message', function(e) {
  console.log('[player] received message:', e.data);
  if (!e.data || !e.data.action) return;
  if (!ready) { pendingCmd = e.data; return; }
  handleCmd(e.data);
});
</script>
</body>
</html>
